{
  "version": "terminale-nsi-v2.0-2025-09-03",
  "locale": "fr-FR",
  "title": "NSI Terminale — Questionnaire d’entrée & Bilans personnalisés",
  "description": "Questionnaire complet de rentrée pour les élèves de Terminale NSI, intégrant les acquis de Première, les profils pédagogiques communs et spécifiques NSI. Génère automatiquement deux bilans PDF (élève & enseignant) via LLM + RAG et LaTeX, déposés dans les dashboards respectifs.",

  "owners": ["alaeddine.benrhouma@ert.tn", "pierre.caillabet@ert.tn"],

  "data_sources": {
    "students_csv": {
      "type": "csv",
      "path": "/mnt/data/TERMINALE_NSI.csv",
      "delimiter": ";",
      "encoding": "utf-8",
      "header": true,
      "columns": {
        "email": "Email",
        "given_name": "Prénom",
        "family_name": "Nom",
        "classe": "Classe",
        "specialites": "Spécialités gardées",
        "id": "ID"
      }
    }
  },

  "auth": {
    "method": "email_domain",
    "domain": "ert.tn",
    "verification": "magic_link",
    "fields": ["email"],
    "lookup": {
      "source": "students_csv",
      "key": "email",
      "prefill": {
        "auth.email": "row.email",
        "auth.given_name": "row.given_name",
        "auth.family_name": "row.family_name",
        "context.csv_classe": "row.classe",
        "context.csv_specialites_raw": "row.specialites",
        "context.student_id": "row.id"
      }
    },
    "guards": [{
      "id": "require_nsi_specialite",
      "rule": "contains_any(context.csv_specialites_raw, ['NSI'])",
      "onFail": {"action": "block", "message": "Ce questionnaire est réservé aux élèves ayant gardé la spécialité NSI en Terminale."}
    }]
  },

  "audience": {"niveau": "Terminale", "specialite": "NSI", "enjeux": ["Parcoursup", "Baccalauréat"]},

  "workflow": {
    "stages": ["intro", "volet_connaissances": {
      "title": "Volet 1 — Connaissances de Première utiles en Terminale (version longue, séance D201)",
      "description": "Banque QCM/QROC élargie : 45–50 questions réparties par domaine (Python, structures, données/CSV, logique & encodage, Web/HTTP, lecture/traçage d’algorithmes). Pondération renforcée sur les prérequis critiques.",
      "delivery": {"randomize": true, "timeLimitMin": 60, "showSolutions": false, "shuffleChoices": true},
      "domain_weights": {"python": 0.25, "structures": 0.22, "donnees": 0.20, "logique": 0.12, "web": 0.11, "lecture_algo": 0.10},
      "selection": {
        "by_domain": {
          "python": {"total": 10, "difficulty_mix": {"A": 5, "B": 4, "C": 1}},
          "structures": {"total": 9, "difficulty_mix": {"A": 4, "B": 4, "C": 1}},
          "donnees": {"total": 8, "difficulty_mix": {"A": 4, "B": 3, "C": 1}},
          "logique": {"total": 6, "difficulty_mix": {"A": 4, "B": 2}},
          "web": {"total": 6, "difficulty_mix": {"A": 4, "B": 2}},
          "lecture_algo": {"total": 6, "difficulty_mix": {"A": 4, "B": 2}}
        },
        "max_items": 45
      },
      "bank_imports": [
        {"path": "/mnt/data/qcm_premiere_for_terminale_nsi.json", "format": "json", "domainField": "domain", "idField": "id", "weightField": "weight"}
      ],
      "bank_append": [/* QCM supplémentaires déjà intégrés dans version étendue */]
    ,"explanation":"// est la division entière; % est le reste."},
        {"id":"PY-A-02","domain":"python","type":"mcq","difficulty":"A","weight":1,"statement":"Quelle tranche renvoie [2,3] pour L=[0,1,2,3,4]?","choices":[{"k":"A","text":"L[2:4]","correct":true},{"k":"B","text":"L[2:3]"},{"k":"C","text":"L[1:3]"}],"explanation":"La borne haute est exclue."},
        {"id":"PY-B-03","domain":"python","type":"mcq","difficulty":"B","weight":1,"statement":"Fonctions : laquelle est valide ?","choices":[{"k":"A","text":"def f(x,y=0,z): return x+y+z"},{"k":"B","text":"def f(x, y=0, z=1): return x+y+z","correct":true},{"k":"C","text":"def f(x; y): return x+y"}],"explanation":"Les paramètres par défaut doivent être en fin de liste."},
        {"id":"PY-B-04","domain":"python","type":"mcq","difficulty":"B","weight":1,"statement":"Mutabilité : que vaut L ?","code":"python
L=[1,2]; M=L; M.append(3); print(L)","choices":[{"k":"A","text":"[1,2]"},{"k":"B","text":"[1,2,3]","correct":true},{"k":"C","text":"Erreur"}],"explanation":"Listes mutables et aliasage."},
        {"id":"PY-C-05","domain":"python","type":"short","difficulty":"C","weight":1,"statement":"Écrire une compréhension renvoyant les carrés pairs de 0 à 10 inclus.","answer":"[x*x for x in range(0,11) if x%2==0]"},
        {"id":"PY-A-06","domain":"python","type":"msq","difficulty":"A","weight":1,"statement":"Quelles expressions valent True ?","choices":[{"k":"A","text":"(3<4) and (not False)","correct":true},{"k":"B","text":"len('abc')==3","correct":true},{"k":"C","text":"None==0"},{"k":"D","text":"5=='5'"}]},
        {"id":"PY-B-07","domain":"python","type":"mcq","difficulty":"B","weight":1,"statement":"Portée : quel affichage ?","code":"python
x=1
def g():
    x=2
    def h():
        return x
    return h()
print(g())","choices":[{"k":"A","text":"1"},{"k":"B","text":"2","correct":true},{"k":"C","text":"Erreur"}]},
        {"id":"PY-B-08","domain":"python","type":"mcq","difficulty":"B","weight":1,"statement":"Que vaut sum(i for i in range(3,8,2)) ?","choices":[{"k":"A","text":"12"},{"k":"B","text":"15","correct":true},{"k":"C","text":"18"}]},

        /* STRUCTURES (listes/dicos/tuples/ensembles) */
        {"id":"ST-A-01","domain":"structures","type":"mcq","difficulty":"A","weight":1,"statement":"Dictionnaires : que renvoie ?","code":"python
d={'a':1,'b':2}
print('a' in d, 2 in d, 2 in d.values())","choices":[{"k":"A","text":"True True True"},{"k":"B","text":"True False True","correct":true},{"k":"C","text":"True False False"}]},
        {"id":"ST-A-02","domain":"structures","type":"mcq","difficulty":"A","weight":1,"statement":"Tuples : accès valide pour t=(10,20) ?","choices":[{"k":"A","text":"t[0]=5"},{"k":"B","text":"t[1]","correct":true},{"k":"C","text":"t.append(30)"}]},
        {"id":"ST-B-03","domain":"structures","type":"mcq","difficulty":"B","weight":1,"statement":"Ensembles : résultat ?","code":"python
A={1,2,3}; B={3,4}
print(A|B, A&B, A-B)","choices":[{"k":"A","text":"{1,2,3,4} {3} {1,2}","correct":true},{"k":"B","text":"{1,2,3} { } {1,2}"},{"k":"C","text":"{1,2,3,4} {1,2} {3}"}]},
        {"id":"ST-B-04","domain":"structures","type":"mcq","difficulty":"B","weight":1,"statement":"Listes : que vaut L ?","code":"python
L=[0,1,2,3]
L[1:3]=[9]
print(L)","choices":[{"k":"A","text":"[0,9,3]","correct":true},{"k":"B","text":"[0,9,2,3]"},{"k":"C","text":"[0,1,9,3]"}]},
        {"id":"ST-B-05","domain":"structures","type":"msq","difficulty":"B","weight":1,"statement":"Opérations dict valides ?","choices":[{"k":"A","text":"d.get('k',0)","correct":true},{"k":"B","text":"d.items()","correct":true},{"k":"C","text":"d.push(1)"},{"k":"D","text":"d.update({'x':1})","correct":true}]},
        {"id":"ST-C-06","domain":"structures","type":"short","difficulty":"C","weight":1,"statement":"Écrire une dict‑compréhension inversant d={'a':1,'b':2}.","answer":"{v:k for k,v in d.items()}"},
        {"id":"ST-A-07","domain":"structures","type":"mcq","difficulty":"A","weight":1,"statement":"Compréhension de liste :","code":"python
L=[i for i in range(5) if i%2]","choices":[{"k":"A","text":"[0,2,4]"},{"k":"B","text":"[1,3]","correct":true},{"k":"C","text":"[1,2,3,4]"}]},

        /* DONNÉES / CSV */
        {"id":"DN-A-01","domain":"donnees","type":"mcq","difficulty":"A","weight":1,"statement":"Module standard pour lire un CSV ?","choices":[{"k":"A","text":"csv","correct":true},{"k":"B","text":"pandas"},{"k":"C","text":"sqlite3"}]},
        {"id":"DN-A-02","domain":"donnees","type":"mcq","difficulty":"A","weight":1,"statement":"Filtrage de lignes : résultat ?","code":"python
rows=[{'classe':'TNSI','nom':'Ali'},{'classe':'1G','nom':'Zoé'}]
sel=[r for r in rows if r['classe']=='TNSI']
print(len(sel))","choices":[{"k":"A","text":"0"},{"k":"B","text":"1","correct":true},{"k":"C","text":"2"}]},
        {"id":"DN-B-03","domain":"donnees","type":"mcq","difficulty":"B","weight":1,"statement":"csv.DictReader :","choices":[{"k":"A","text":"Renvoie des tuples"},{"k":"B","text":"Renvoie des dict par ligne","correct":true},{"k":"C","text":"Écrit un CSV"}],"explanation":"DictReader itère sur des dict mappant en-têtes->valeurs."},
        {"id":"DN-B-04","domain":"donnees","type":"mcq","difficulty":"B","weight":1,"statement":"Conversion : que vaut int('08') ?","choices":[{"k":"A","text":"8","correct":true},{"k":"B","text":"Erreur"},{"k":"C","text":"0"}]},
        {"id":"DN-C-05","domain":"donnees","type":"short","difficulty":"C","weight":1,"statement":"Écrire le code Python (3 lignes) lisant un CSV 'eleves.csv' et comptant les lignes (header inclus).","answer":"import csv
with open('eleves.csv', newline='') as f:
    print(sum(1 for _ in csv.reader(f)))"},
        {"id":"DN-B-06","domain":"donnees","type":"mcq","difficulty":"B","weight":1,"statement":"Nettoyage : quelle stratégie pour trim des espaces autour des champs ?","choices":[{"k":"A","text":"strip() sur chaque valeur","correct":true},{"k":"B","text":"upper()"},{"k":"C","text":"split(',') brut"}]},

        /* LOGIQUE & ENCODAGE */
        {"id":"LG-A-01","domain":"logique","type":"mcq","difficulty":"A","weight":1,"statement":"Binaire 1010 1100 = ? (hexa)","choices":[{"k":"A","text":"0xAC","correct":true},{"k":"B","text":"0xCA"},{"k":"C","text":"0xAA"}]},
        {"id":"LG-A-02","domain":"logique","type":"mcq","difficulty":"A","weight":1,"statement":"Table correcte pour XOR ?","choices":[{"k":"A","text":"0⊕0=0, 0⊕1=1, 1⊕0=1, 1⊕1=0","correct":true},{"k":"B","text":"0⊕0=1, 0⊕1=0, 1⊕0=0, 1⊕1=1"},{"k":"C","text":"0⊕0=0, 0⊕1=0, 1⊕0=0, 1⊕1=1"}]},
        {"id":"LG-B-03","domain":"logique","type":"mcq","difficulty":"B","weight":1,"statement":"Sur 8 bits signé (C2), intervalle représentable :","choices":[{"k":"A","text":"[-255,255]"},{"k":"B","text":"[-128,127]","correct":true},{"k":"C","text":"[0,255]"}]},
        {"id":"LG-B-04","domain":"logique","type":"mcq","difficulty":"B","weight":1,"statement":"Pourquoi 0.1+0.2≠0.3 en binaire flottant ?","choices":[{"k":"A","text":"Bug du langage"},{"k":"B","text":"Arrondi/representation binaire finie","correct":true},{"k":"C","text":"Division par 0"}]},

        /* WEB & HTTP */
        {"id":"WB-A-01","domain":"web","type":"mcq","difficulty":"A","weight":1,"statement":"Paramètres d’un formulaire GET ?","choices":[{"k":"A","text":"Dans le corps (body)"},{"k":"B","text":"Dans la chaîne de requête, après ?","correct":true},{"k":"C","text":"Dans les en‑têtes"}]},
        {"id":"WB-A-02","domain":"web","type":"mcq","difficulty":"A","weight":1,"statement":"HTTPS garantit :","choices":[{"k":"A","text":"Chiffrement client‑serveur","correct":true},{"k":"B","text":"Pas de latence"},{"k":"C","text":"Stockage persistant"}]},
        {"id":"WB-B-03","domain":"web","type":"mcq","difficulty":"B","weight":1,"statement":"Quel code statut pour ressource non trouvée ?","choices":[{"k":"A","text":"200"},{"k":"B","text":"301"},{"k":"C","text":"404","correct":true}]},
        {"id":"WB-B-04","domain":"web","type":"mcq","difficulty":"B","weight":1,"statement":"Méthode HTTP idempotente :","choices":[{"k":"A","text":"GET","correct":true},{"k":"B","text":"POST"},{"k":"C","text":"PATCH"}]},

        /* LECTURE / TRAÇAGE D'ALGORITHMES */
        {"id":"AL-A-01","domain":"lecture_algo","type":"mcq","difficulty":"A","weight":1,"statement":"Affichage ?","code":"python
 def f(n):
     s=0
     for i in range(1,n+1):
         if i%2==0: s+=i
     return s
print(f(5))","choices":[{"k":"A","text":"6","correct":true},{"k":"B","text":"9"},{"k":"C","text":"12"}]},
        {"id":"AL-A-02","domain":"lecture_algo","type":"mcq","difficulty":"A","weight":1,"statement":"Résultat ?","code":"python
L=[3,1,2]
for i in range(len(L)):
    L[i]=L[i]**2
print(L)","choices":[{"k":"A","text":"[3,1,2]"},{"k":"B","text":"[9,1,4]","correct":true},{"k":"C","text":"[6,2,4]"}]},
        {"id":"AL-B-03","domain":"lecture_algo","type":"mcq","difficulty":"B","weight":1,"statement":"Complexité : quelle est la complexité de la double boucle imbriquée ci‑dessous ?","code":"python
for i in range(n):
    for j in range(n):
        k += 1","choices":[{"k":"A","text":"O(n)"},{"k":"B","text":"O(n log n)"},{"k":"C","text":"O(n^2)","correct":true}]},
        {"id":"AL-B-04","domain":"lecture_algo","type":"short","difficulty":"B","weight":1,"statement":"Écrire la valeur renvoyée par la fonction :","code":"python
 def g(L):
     m=L[0]
     for x in L:
         if x<m: m=x
     return m
print(g([5,2,9,1]))","answer":"1"}
      ]
    },
    {
      "id": "volet_pedago_commun",
      "title": "Volet 2 — Profil pédagogique commun",
      "import": "/mnt/data/pedago_survey_commun.json"
    },
,
      "title": "Volet 2 — Profil pédagogique commun",
      "import": "/mnt/data/pedago_survey_commun.json"
    },
    {
      "id": "volet_pedago_nsi",
      "title": "Volet 3 — Profil pédagogique spécifique NSI Terminale",
      "import": "/mnt/data/pedago_survey_nsi_terminale.json"
    },
    {
      "id": "consentement",
      "title": "Consentement RGPD",
      "pages": [
        {"id": "rgpd", "questions": [
          {"id": "consentement_data", "type": "checkbox", "statement": "J’autorise l’utilisation de mes réponses pour un bilan pédagogique individuel.", "required": true},
          {"id": "consentement_mail", "type": "checkbox", "statement": "J’accepte de recevoir mon bilan PDF par e‑mail.", "required": true}
        ]}
      ]
    }
  ],

  "scoring": {
  "sections": {
    "volet_connaissances": {
      "mode": "sum_weighted_by_domain",
      "domainMap": {
        "donnees": ["donnees","tables","csv"],
        "python": ["python","py_base"],
        "structures": ["structures","listes","dictionnaires","tuples","ensembles"],
        "logique": ["logique","encodage","binaire","flottants"],
        "web": ["web","http"],
        "lecture_algo": ["lecture_algo","tracage"]
      },
      "weights": {"python":0.25,"structures":0.22,"donnees":0.20,"logique":0.12,"web":0.11,"lecture_algo":0.10},
      "criticalPolicy": "flag_below_50"
    },
    "volet_pedago_commun": {"mode": "profile_bucketed"},
    "volet_pedago_nsi": {"mode": "likert_weighted", "reverseHandling": "auto"}
  },
  "tags": [
    {"id": "TAG_Python_Faible", "rule": "volet_connaissances.python < 0.5"},
    {"id": "TAG_Structures_Faible", "rule": "volet_connaissances.structures < 0.5"},
    {"id": "TAG_Tables_Faible", "rule": "volet_connaissances.donnees < 0.5"},
    {"id": "TAG_Methodes_Faibles", "rule": "volet_pedago_nsi.P5 <= 2 or volet_pedago_nsi.P6 <= 2"},
    {"id": "TAG_Organisation_Faible", "rule": "volet_pedago_nsi.P8 <= 2"},
    {"id": "TAG_Stress_Eleve", "rule": "volet_objectifs.stress_eval >= 4"}
  ],
  "risk_flags": [
    {"id": "ALERTE_Parcoursup", "rule": "(volet_objectifs.objectif_T1 in ['< 10','10–11']) or (volet_objectifs.objectif_T2 in ['< 10','10–11'])"}
  ]
},

"reporting": {
    "provider": "openai",
    "model": "gpt-4o",
    "rag": {
      "sources": [
        {"path": "/mnt/data/programme_nsi_premiere.pdf", "label": "Programme NSI Première"},
        {"path": "/mnt/data/programme_nsi_terminale.pdf", "label": "Programme NSI Terminale"},
        {"path": "/mnt/data/vademecum-snt-nsi_0.pdf", "label": "Vademecum NSI"}
      ]
    },
    "latex_templates": {
      "eleve": "... modèle LaTeX version élève ...",
      "enseignant": "... modèle LaTeX version enseignant ..."
    },
    "prompts": {
      "system_eleve": "Tu écris un bilan court, positif et concret pour l’élève, avec conseils de révision et ressources adaptées.",
      "system_enseignant": "Tu rédiges une analyse complète pour l’enseignant, reliant les résultats aux objectifs du programme et proposant un plan d’appui (4 semaines)."
    },
    "post_actions": {
      "student_dashboard": {"save_pdf": true, "disable_button_id": "start_bilan_button"},
      "teacher_dashboard": {"collect_all": true, "fields": ["bilan_eleve_pdf", "bilan_enseignant_pdf"]},
      "email": {
        "to": ["alaeddine.benrhouma@ert.tn", "pierre.caillabet@ert.tn"],
        "subject": "Bilan NSI Terminale — {{student.family_name}} {{student.given_name}}",
        "attachments": ["bilan_eleve_pdf", "bilan_enseignant_pdf"]
      }
    }
  },

  "security": {"data_retention": "année scolaire en cours", "anonymized_analytics": true}
}
